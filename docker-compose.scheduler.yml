# Docker Compose para IconsAI Scheduler
# Automação de coleta de dados empresariais

version: '3.8'

services:
  scheduler:
    build:
      context: .
      dockerfile: scheduler/Dockerfile
    container_name: iconsai-scheduler
    restart: unless-stopped
    environment:
      # Environment
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - DEBUG=${DEBUG:-false}

      # APIs de busca
      - SERPER_API_KEY=${SERPER_API_KEY}
      - PERPLEXITY_API_KEY=${PERPLEXITY_API_KEY}

      # APIs B2B
      - APOLLO_API_KEY=${APOLLO_API_KEY}
      - CNPJA_API_KEY=${CNPJA_API_KEY}

      # Supabase principal
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}

      # Brasil Data Hub (geo_municipios)
      - BRASIL_DATA_HUB_URL=${BRASIL_DATA_HUB_URL}
      - BRASIL_DATA_HUB_KEY=${BRASIL_DATA_HUB_KEY}

      # Scheduler
      - SCHEDULER_ENABLED=${SCHEDULER_ENABLED:-true}
      - SCHEDULER_HOUR=${SCHEDULER_HOUR:-2}
      - SCHEDULER_MINUTE=${SCHEDULER_MINUTE:-0}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

    volumes:
      # Logs persistentes
      - scheduler_logs:/app/logs

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    healthcheck:
      test: ["CMD", "python", "-c", "import scheduler; print('OK')"]
      interval: 60s
      timeout: 10s
      retries: 3

    networks:
      - iconsai-network

volumes:
  scheduler_logs:

networks:
  iconsai-network:
    driver: bridge
